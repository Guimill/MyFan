name: CI/CD Pipeline

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.12]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run Tests
      run: |
        python manage.py test

    - name: Collect Static Files
      run: |
        python manage.py collectstatic --noinput

    - name: Run Migrations
      run: |
        python manage.py migrate

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.5.3
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Add GitHub to known hosts
      run: ssh-keyscan github.com >> ~/.ssh/known_hosts

    - name: Test SSH Connection
      run: ssh -vT git@github.com

    - name: Deploy
      run: |
        git remote add deploy git@github.com:Guimill/MyFan.git
        git push deploy main

    # Additional debugging steps
    - name: List SSH keys
      run: ssh-add -l

    - name: Check SSH config
      run: cat ~/.ssh/config

    - name: Check SSH known_hosts
      run: cat ~/.ssh/known_hosts
